<template>
    <link
        rel="icon"
        type="image/png"
        href="documentation/assets/img/favicon.png"
    />

    <link
        href="//cloud.typenetwork.com/projects/2160/fontface.css/"
        rel="stylesheet"
        type="text/css"
    />

    <link href="/animejs.css" rel="stylesheet" />

    <section
        id="controls-and-callbacks"
        class="feature-section section-feature-control inverted-section"
    >
        <div class="grid-container large-grid">
            <div class="feature-description">
                <h1 class="feature-title">Chronologie Acaédemique</h1>
                <h2 class="feature-subtitle">Visualiser le Futur</h2>
            </div>

            <div class="feature-animation">
                <div class="time-control">
                    <div class="ruller">
                        <div
                            class="time-cursor color-red"
                        >
                            <input value="0" />
                        </div> 
                    </div>
                    <div class="timeline">
                        <div
                            class="info-loop-begin info info-large info-left info-bottom"
                            data-delay="0"
                        >
                            <div
                                class="info-bar"
                            ></div>
                            <figcaption
                                class="feature-caption"
                            >
                            FST
                            </figcaption>
                            <figcaption
                                class="feature-caption"
                            >
                            Ecole des Sciences et Technologies
                            </figcaption>
                        </div>
                        <div class="animation">
                            <div class="animation-band animation-delay"></div>
                            <div
                                class="info-change-begin info info-left info-bottom"
                                data-delay="100"
                            >
                                <div
                                    class="info-bar"

                                ></div>
                                <figcaption
                                    class="feature-caption text-purple-900"
                                >
                                Génie Electrique et Systèmes Automatisés
                                    
                                </figcaption>
                            </div>
                            <div class="animation-band animation-change"></div>
                            <div
                                class="info-change-complete info info-right info-top"
                                data-delay="400"
                            >
                                <div
                                    class="info-bar"

                                ></div>
                                <figcaption
                                    class="feature-caption text-stone-400"
                                >
                                    BAC+2 
                                </figcaption>
                            </div>
                            <div
                                class="animation-band animation-end-delay"
                            ></div>
                        </div>
                        <div
                            class="info-loop-complete info info-large info-right info-top"
                            data-delay="500"
                        >
                            <div
                                class="info-bar"
                            ></div>
                            <figcaption
                                class="feature-caption text-rose-700"
                            >
                            Diplôme universitaire de technologie
                            </figcaption>
                        </div>
                        <div
                            class="info info-large info-left info-bottom"
                            data-delay="500"
                        >
                            <div
                                class="info-bar"
                            ></div>
                            <figcaption
                                class="feature-caption"
                            >
                            FS
                            </figcaption>
                            <figcaption
                                class="feature-caption"
                            >
                                Faculté des Sciences
                            </figcaption>
                        </div>
                        <div class="animation">
                            <div
                                class="animation-band animation-delay"
                            ></div>
                            <div
                                class="info-change-begin info info-left info-bottom"
                                data-delay="600"
                            >
                                <div
                                    class="info-bar"

                                ></div>
                                <figcaption
                                    class="feature-caption text-purple-900"
                                >
                                Ingénierie de l'Eau et de l'Environnement
                                </figcaption>
                            </div>
                            <div class="animation-band animation-change"></div>
                            <div
                                class="info-change-complete info info-right info-top"
                                data-delay="900"
                            >
                                <div
                                    class="info-bar"

                                ></div>
                                <figcaption
                                    class="feature-caption text-stone-400"
                                >
                                    BAC+3 
                                </figcaption>
                            </div>
                            <div class="animation-band animation-end-delay"></div>
                        </div>
                        <div
                            class="info-loop-complete info info-large info-right info-top"
                            data-delay="1000"
                        >
                            <div
                                class="info-bar"
                            ></div>
                            <figcaption
                                class="feature-caption text-rose-700"
                            >
                            Licence
                            </figcaption>
                        </div>
                        <div
                            class="info info-large info-left info-bottom"
                            data-delay="1000"
                        >
                            <div
                                class="info-bar"
                            ></div>
                            <figcaption
                                class="feature-caption"
                            >
                                FS
                            </figcaption>
                            <figcaption
                                class="feature-caption"
                            >
                            Faculté des Sciences
                            </figcaption>
                        </div>
                        <div class="animation">
                            <div class="animation-band animation-delay"></div>
                            <div
                                class="info-change-begin info info-left info-bottom"
                                data-delay="1100"
                            >
                                <div
                                    class="info-bar"
                             
                                ></div>
                                <figcaption
                                    class="feature-caption text-purple-900"
                                >
                                Ingénierie et Gestion de l'Eau et de l'Assainissement
                                </figcaption>
                            </div>
                            <div class="animation-band animation-change"></div>
                            <div
                                class="info-change-complete info info-right info-top"
                                data-delay="1400"
                            >
                                <div
                                    class="info-bar"
                                ></div>
                                <figcaption
                                    class="feature-caption text-stone-400"
                                >
                                    BAC+5 
                                </figcaption>
                            </div>
                            <div
                                class="animation-band animation-end-delay"
                            ></div>
                        </div>
                        <div
                            class="info-loop-complete info info-large info-right info-top"
                            data-delay="1500"
                        >
                            <div
                                class="info-bar"
                            ></div>
                            <figcaption
                                class="feature-caption text-rose-700"
                             
                            >
                            Master Spécialisé
                                
                            </figcaption>
                            <figcaption
                                class="feature-caption text-emerald-700"
                            >
                            Succès
                            </figcaption>
                        </div>
                    </div>
                </div>
            </div>

            <div class="feature-description feature-description-grid">
                <div class="feature-description-icons">
                    <div class="feature-icons-container vertical-icons">
                        <figure class="feature-icon timeline-icon">
                            <div class="animation-band animation-delay"></div>
                            <figcaption class="feature-caption">
                                Ecole
                            </figcaption>
                        </figure>
                        <figure class="feature-icon timeline-icon">
                            <div
                                class="animation-band animation-end-delay"
                            ></div>
                            <figcaption class="feature-caption">
                                Diplôme
                            </figcaption>
                        </figure>
                        <figure class="feature-icon timeline-icon">
                            <div class="animation-band animation-change"></div>
                            <figcaption class="feature-caption">
                                Formation
                            </figcaption>
                        </figure>
                    </div>
                </div>
                <div class="feature-description-text">
                    <p class="feature-paragraph">
                        Un résumé de la carrière d'un étudiant de l'Ecole des Sciences et Technologies de l'Université de Lomé.
                    </p>
                    <p class="feature-paragraph">
                        <a href="" class="primary arrow"
                            >www.site-ecole.com</a
                        >
                    </p>
                </div>
            </div>
        </div>
    </section>
</template>

<script setup>
import anime from "animejs";
import { onMounted, onUnmounted } from 'vue';

// Helper functions
function dragElement(el, events) {
    function getPointer(e) {
        var x = "clientX";
        var y = "clientY";
        var evt = e.touches ? e.touches[0] : e;
        return { x: evt[x], y: evt[y] };
    }

    var drag = {
        x: 0,
        y: 0,
        deltaX: 0,
        deltaY: 0,
        active: true,
        events: events || {},
    };
    var originalX = 0;
    var originalY = 0;
    var pointerX = 0;
    var pointerY = 0;

    function move(e) {
        if (drag.active) return;
        drag.deltaX = pointerX - getPointer(e).x;
        drag.deltaY = pointerY - getPointer(e).y;
        drag.x = originalX - drag.deltaX;
        drag.y = originalY - drag.deltaY;
        if (drag.events.move) drag.events.move(drag);
    }

    function release(e) {
        drag.active = true;
        if (drag.events.release) drag.events.release(drag);
        document.removeEventListener("mousemove", move, false);
        document.removeEventListener("mouseup", release, false);
        document.removeEventListener("touchmove", move, false);
        document.removeEventListener("touchend", release, false);
    }

    function start(e) {
        if (!drag.active) return;
        e.preventDefault();
        drag.active = false;
        pointerX = getPointer(e).x;
        pointerY = getPointer(e).y;
        originalX = drag.x;
        originalY = drag.y;
        if (drag.events.begin) drag.events.begin(drag);
        document.addEventListener("mousemove", move, false);
        document.addEventListener("mouseup", release, false);
        document.addEventListener("touchmove", move, false);
        document.addEventListener("touchend", release, false);
    }

    el.addEventListener("mousedown", start, false);
    el.addEventListener("touchstart", start, false);

    return drag;
}

function onScroll(cb) {
    let isTicking = false;
    let scrollY = 0;
    const body = document.body;
    const html = document.documentElement;
    const scrollHeight = Math.max(
        body.scrollHeight,
        body.offsetHeight,
        html.clientHeight,
        html.scrollHeight,
        html.offsetHeight
    );

    function scroll() {
        scrollY = window.scrollY;
        if (cb) cb(scrollY, scrollHeight);
        requestTick();
    }

    function requestTick() {
        if (!isTicking) requestAnimationFrame(updateScroll);
        isTicking = true;
    }

    function updateScroll() {
        isTicking = false;
        const currentScrollY = scrollY;
    }

    scroll();
    window.onscroll = scroll;
}

function scrollToElement(el, offset) {
    const off = offset || 0;
    const rect = el.getBoundingClientRect();
    const top = rect.top + off;
    const animation = anime({
        targets: [document.body, document.documentElement],
        scrollTop: "+=" + top,
        easing: "easeInOutSine",
        duration: 1500,
    });
}

function isElementInViewport(el, inCB, outCB, rootMargin) {
    const margin = rootMargin || "-10%";
    function handleIntersect(entries, observer) {
        const entry = entries[0];
        if (entry.isIntersecting) {
            if (inCB && typeof inCB === "function") inCB(el, entry);
        } else {
            if (outCB && typeof outCB === "function") outCB(el, entry);
        }
    }
    const observer = new IntersectionObserver(handleIntersect, {
        rootMargin: margin,
    });
    observer.observe(el);
}

function fitElementToParent(el, padding, exception) {
    let windowWidth = 0;
    let timeout = 0;
    
    function resize() {
        anime.set(el, { scale: 1 });
        if (exception) anime.set(exception, { scale: 1 });
        const pad = padding || 0;
        const parentEl = el.parentNode;
        const elOffsetWidth = el.offsetWidth - pad;
        const parentOffsetWidth = parentEl.offsetWidth;
        const ratio = parentOffsetWidth / elOffsetWidth;
        const invertedRatio = elOffsetWidth / parentOffsetWidth;
        anime.set(el, { scale: ratio });
        if (exception) anime.set(exception, { scale: invertedRatio });
    }

    resize();
    window.addEventListener("resize", () => {
        if (window.innerWidth === windowWidth) return;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            windowWidth = window.innerWidth;
            resize();
        }, 15);
    });
}

// Main animation setup
onMounted(() => {
    const timeControlEl = document.querySelector(".time-control");
    const rullerEl = document.querySelector(".ruller");
    const timeCursorEl = document.querySelector(".time-cursor");
    const timeEl = document.querySelector(".time-cursor input");
    const infoEls = document.querySelectorAll(".info");
    const fragment = document.createDocumentFragment();
    const numberOfElements = 271;
    let controlAnimationCanMove = false;

    for (let i = 0; i < numberOfElements; i++) {
        const dotEl = document.createElement("div");
        dotEl.classList.add("line");
        fragment.appendChild(dotEl);
    }

    rullerEl.appendChild(fragment);

    const animationPXOffset = Math.max(
        (timeControlEl.offsetWidth - (timeControlEl.parentNode.offsetWidth - 20)) / 2,
        0
    );

    function pxToTime(px) {
        const width = window.innerWidth > rullerEl.offsetWidth
            ? rullerEl.offsetWidth + 180
            : window.innerWidth;
        const percent = px / width;
        return percent * timelineAnimation.duration;
    }

    const time = {
        anim: null,
        start: 0,
        end: 0,
    };

    const drag = dragElement(timeCursorEl, {
        begin: (e) => {
            anime.remove(time);
            time.start = timelineAnimation.currentTime;
            controlAnimationCanMove = false;
        },
        move: (e) => {
            timelineAnimation.seek(time.start + pxToTime(-e.deltaX));
        },
        release: (e) => {
            time.end = timelineAnimation.currentTime;
            anime.remove(time);
            time.anim = anime({
                targets: time,
                end: time.start,
                easing: "spring(.3, 200, 5, 1)",
                update: () => {
                    timelineAnimation.seek(time.end);
                },
                complete: () => {
                    controlAnimationCanMove = true;
                    moveControlAnimation();
                },
            });
        },
    });

    const timelineAnimation = anime.timeline({
        easing: "linear",
        autoplay: false,
    })
    .add({
        targets: timeControlEl,
        translateX: [animationPXOffset, -animationPXOffset],
        duration: 1500,
    }, 0)
    .add({
        targets: timeCursorEl,
        translateZ: 0,
        keyframes: [
            {
                translateY: [-24, 0],
                duration: 100,
                easing: "easeInQuad",
            },
            { translateX: 1080, duration: 1500 },
            { translateY: -24, duration: 100, easing: "easeOutQuad" },
        ],
        duration: 1500,
    }, -100)
    .add({
        targets: ".ruller .line",
        // First value object controls movement down by 24px, second moves back to original Y position
        translateY: [{ value: 24 }, { value: 0 }],
        // First value object controls movement right by 24px, second moves back to original X position  
        duration: 160,
        delay: anime.stagger([0, 1500]),
        easing: "easeInOutSine",
    }, -80)
    .add({
        targets: timeEl,
        value: [{ value: [0, 100] }, { value: 0 }, { value: 100 }],
        duration: 1500,
        round: 1,
        easing: "linear",
    }, 0);

    infoEls.forEach((infoEl) => {
        const delay = parseFloat(anime.get(infoEl, "data-delay"));
        const direction = infoEl.classList.contains("info-bottom") ? -1 : 1;
        
        timelineAnimation
            .add({
                targets: infoEl.querySelector(".info-bar"),
                scaleY: [0, 1],
                duration: 250,
                easing: "easeOutCirc",
            }, delay)
            .add({
                targets: infoEl.querySelectorAll(".info .feature-caption"),
                opacity: [0, 1],
                translateY: [direction * 10, 0],
                duration: 50,
                delay: anime.stagger(50, {
                    start: 10,
                    direction: direction > 0 ? "reverse" : "normal",
                }),
                easing: "easeOutSine",
            }, delay);
    });

    let windowHeight = window.innerHeight;
    let scrollAnim;

    function moveControlAnimation() {
        const rect = timeControlEl.getBoundingClientRect();
        const top = rect.top;
        const scrolled = (top - windowHeight + 100) * -1.5;
        timelineAnimation.seek(scrolled * 2);
        if (controlAnimationCanMove) {
            scrollAnim = requestAnimationFrame(moveControlAnimation);
        }
    }

    isElementInViewport(
        timeControlEl,
        (el, entry) => {
            windowHeight = window.innerHeight;
            controlAnimationCanMove = true;
            moveControlAnimation();
        },
        (el, entry) => {
            controlAnimationCanMove = false;
        },
        "50px"
    );

    onScroll((scrollY) => {
        if (time.anim && !time.anim.paused) {
            time.anim.pause();
            controlAnimationCanMove = true;
            moveControlAnimation();
        }
    });
});
</script>
